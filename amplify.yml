version: 1
frontend:
  phases:
    preBuild:
      commands:
        - yarn install
    build:
      commands:
        # Export and verify environment variables
        - |
          echo "üîç Verifying AWS Amplify environment variables..."
          
          # Function to safely display variable info
          safe_var_info() {
            local var_name=$1
            local var_value=$2
            if [ -z "$var_value" ]; then
              echo "‚ùå $var_name: undefined"
            else
              local length=${#var_value}
              if [ $length -le 4 ]; then
                echo "‚úÖ $var_name: ****"
              else
                local first_two="${var_value:0:2}"
                local last_two="${var_value: -2}"
                echo "‚úÖ $var_name: $first_two...$last_two (length: $length)"
              fi
            fi
          }
          
          # Function to safely display URL domain
          safe_url_info() {
            local var_name=$1
            local var_value=$2
            if [ -z "$var_value" ]; then
              echo "‚ùå $var_name: undefined"
            else
              echo "‚úÖ $var_name: $(echo $var_value | sed -E 's/.*:\/\/([^/]+).*/\1/')"
            fi
          }
          
          echo "\nüìù Environment Variable Details:"
          safe_url_info "NEXTAUTH_URL" "$NEXTAUTH_URL"
          safe_var_info "NEXTAUTH_SECRET" "$NEXTAUTH_SECRET"
          safe_url_info "NEO4J_URI" "$NEO4J_URI"
          safe_var_info "NEO4J_USER" "$NEO4J_USER"
          echo "‚úÖ NEO4J_PASSWORD: (length: ${#NEO4J_PASSWORD})"
          
          echo "\nüì§ Creating environment files..."
          # Create .env.production
          echo "NEXTAUTH_URL=$NEXTAUTH_URL" > .env.production
          echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> .env.production
          echo "NEO4J_URI=$NEO4J_URI" >> .env.production
          echo "NEO4J_USER=$NEO4J_USER" >> .env.production
          echo "NEO4J_PASSWORD=$NEO4J_PASSWORD" >> .env.production
          
          # Copy to .env.local
          cp .env.production .env.local
          
          echo "‚úÖ Environment files created"
          
          # Final verification
          if [ -z "$NEXTAUTH_URL" ] || [ -z "$NEXTAUTH_SECRET" ] || [ -z "$NEO4J_URI" ] || [ -z "$NEO4J_USER" ] || [ -z "$NEO4J_PASSWORD" ]; then
            echo "\n‚ùå Error: Missing required environment variables"
            exit 1
          fi
          
          echo "\n‚úÖ All environment variables verified. Starting build..."
        - yarn build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'SAMEORIGIN'
        - key: 'X-XSS-Protection'
          value: '1; mode=block'
    - pattern: '/api/auth/**/*'
      headers:
        - key: 'Cache-Control'
          value: 'no-store, max-age=0'
